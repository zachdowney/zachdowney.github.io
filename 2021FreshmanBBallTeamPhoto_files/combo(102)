YUI.add("album-route",function(e){function t(e){t.superclass.constructor.call(this,e)}var a=require("hermes-core/type-validator");e.Routes[this.name]=t,e.extend(t,e.FlickrRoute,{langBundles:this.details.langBundles,run:function(t){var r,o,i,s=this,n={},l="/photos/"+t.params.nsid_or_path_alias+"/albums/"+t.params.set_id+"/",u=t.params&&t.params.photo_id,p=u?100:25,d=this.getPageNumber(t),g=!!t.headers&&t.headers["user-agent"],m=t.query?t.query:{},h=!1,c=t.params.nsid_or_path_alias,f=[];return g&&null!==g.match(/^Twitterbot/i)&&(h=!0),n.id=t.params.set_id,r={page:100/p*(d-1)+1,perPage:p,withPhotoId:u},f.push(this.appContext.getModel("set-models",n,r)),this.appContext.getViewer().signedIn||t.probableUser?f.push(this.appContext.getModel("person-preferences-models",this.appContext.getViewer().signedIn?this.appContext.getViewer().nsid:t.probableUser)):o=m.layout?m.layout:"story",e.Promise.all(f).catch(function(e){if(e.getModelFailure&&t.probableUser)return t.probableUser=null,[];throw e}).then(function(n){var p=0,g=n[0];if(n[1]&&(o=n[1].getValue("albumViewLayoutPref")),YUI.Env.isServer&&(p=Math.ceil(g.getValue("totalCount")/100),d>p&&r.page>1&&!isNaN(parseInt(t.params.page_number,10))))return e.Promise.resolve({redirect:l.replace(/page[0-9]+/,"")});if(c!==g.getValue("owner").getValue(a.nsid(c)?"id":"pathAlias"))return s.onRouteRejected({message:"Album "+g.getValue("id")+" is not owned by "+c},t);if(u){var m=g.getValue("photoPageList");if(-1===(i=m.getPageOf({id:u},50))||m.getNextIncompletePage(r)===i)return r.forceAPICall=!0,m.getPage(r).then(function(e){return-0===(d=Math.ceil(50*m.getPageOf({id:u},50)/100))&&(d=0),i=d,s.onRouteResolved(g,d,i,l,u,h,o,c)},function(e){return 2===e.code?(d=s.getPageNumber(t),i=2*(d-1)+1,s.onRouteResolved(g,d,i,l,u,h,o,c)):s.onRouteRejected(e,t)});d=Math.ceil(50*m.getPageOf({id:u},50)/100),i=d}else i=2*(d-1)+1;return s.onRouteResolved(g,d,i,l,u,h,o,c)}).catch(function(a){if(2===a.code)return e.Promise.resolve({redirect:l});if(a.timeout){return e.Promise.resolve({view:"empty-album-page-view",layout:"scrolling",params:{}})}return s.onRouteRejected(a,t)})},onRouteResolved:function(t,a,r,o,i,s,n,l){var u={idAttribute:"id",page:r,perPage:i?100:50,viewPageSizeForShare:100,nominalPage:a};return this.appContext.flipper.isFlipped("enable-album-pagination")&&(u.viewPageSize=100),e.Promise.resolve({view:"album-page-view",layout:"scrolling",title:t.getValue("title"),params:{albumId:t.id,nsid:t.getValue("owner").getValue("nsid"),baseURL:o,isTwitterbot:s,albumPhotoListLayoutStyle:n,withPhotoId:i,nsidOrPathAlias:l,pageParams:u}})},onRouteRejected:function(t,a){if(t.fatal)throw t;return this.appContext.getViewer().signedIn?this.displayRouteErrors(a,new e.RouteError(404,this.intlMessage({intlName:"common.404_ALBUM_NONEXISTENT"}),{modelType:"sets-models",modelID:this.getNSIDOrPathAlias(a.params.nsid_or_path_alias)})):this.displayRouteErrors(a,new e.RouteError(403,this.intlMessage({intlName:"common.404_ALBUM_PRIVATE"})))}}),e.mix(t.prototype,e.Localizable)},"@VERSION@",{requires:["flickr-route","flickr-promise","set-models","person-preferences-models"],langBundles:["common"]});